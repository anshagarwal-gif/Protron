[{"filePath":"D:\\Protron\\ProtronClient\\src\\components\\AddInvoice.jsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Unexpected token .","line":207,"column":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useRef, useEffect, useCallback } from 'react';\r\nimport CreatableSelect from 'react-select/creatable';\r\nimport OrganizationSelect from './OrganizationSelect'; // Import OrganizationSelect\r\nimport axios from 'axios';\r\nimport {\r\n    X,\r\n    Calendar,\r\n    User,\r\n    Building,\r\n    DollarSign,\r\n    FileText,\r\n    Download,\r\n    Plus,\r\n    CreditCard,\r\n    Clock,\r\n    MessageSquare,\r\n    Paperclip,\r\n    Trash2,\r\n    EyeIcon,\r\n    Folder,\r\n    AlertCircle\r\n} from 'lucide-react';\r\nimport GlobalSnackbar from './GlobalSnackbar';\r\n\r\n// API Base URL\r\nconst API_BASE_URL = import.meta.env.VITE_API_URL;\r\n\r\n// Currency symbols mapping\r\nconst currencySymbols = {\r\n    USD: '$',\r\n    INR: '₹',\r\n    EUR: '€',\r\n    GBP: '£',\r\n    JPY: '¥',\r\n    CAD: 'C$',\r\n    AUD: 'A$'\r\n};\r\n\r\nconst AddInvoiceModal = ({\r\n    open,\r\n    onClose,\r\n    onSubmit,\r\n    timesheetData,\r\n    viewMode,\r\n    // currentWeekStart,\r\n    // currentMonthRange,\r\n    employee,\r\n    isFromInvoiceManagement = false\r\n}) => {\r\n    const [formData, setFormData] = useState({\r\n        invoiceName: '',\r\n        invoiceType: 'DOMESTIC',\r\n        invoiceDate: '',\r\n        taxId: '',\r\n        billPeriod: '',\r\n        customerName: '',\r\n        billToAddress: '',\r\n        shipToAddress: '',\r\n        customerInfo: '',\r\n        supplierName: sessionStorage.getItem('tenantName') || '',\r\n        supplierAddress: '',\r\n        supplierInfo: '',\r\n        employeeName: '',\r\n        employeeNames: [],\r\n        employeeIds: [],\r\n        rate: '',\r\n        currency: 'USD',\r\n        fromDate: '',\r\n        toDate: '',\r\n        hoursSpent: '',\r\n        totalAmount: '',\r\n        remarks: '',\r\n        projectName: '',\r\n        employeeId: ''\r\n    });\r\n\r\n    // Table headers editable by user\r\n    const [tableHeaders, setTableHeaders] = useState({\r\n        col1: 'Item Description',\r\n        col2: 'Rate',\r\n        col3: 'Quantity',\r\n        col4: 'Amount (Currency)',\r\n        col5: 'Remarks'\r\n    });\r\n\r\n    // Invoice line items (max 5)\r\n    const [items, setItems] = useState([\r\n        { id: 1, description: '', rate: '', quantity: '', amount: '', remarks: '' }\r\n    ]);\r\n\r\n    // Employee rows (max 5). Each row holds selected employee and line fields\r\n    const [invoiceEmployees, setInvoiceEmployees] = useState([\r\n        { id: 1, userId: '', rate: '', quantity: '', amount: '', remarks: '' }\r\n    ]);\r\n\r\n    // const [customers, setCustomers] = useState([]);\r\n    // const [suppliers, setSuppliers] = useState([]);\r\n    const [employees, setEmployees] = useState([]);\r\n    // const [customerAddresses, setCustomerAddresses] = useState([]);\r\n    // const [supplierAddresses, setSupplierAddresses] = useState([]);\r\n    const [isCalculating, setIsCalculating] = useState(false);\r\n    const [loading, setLoading] = useState(false);\r\n    const [errors, setErrors] = useState({});\r\n    const [loadingEmployees, setLoadingEmployees] = useState(false);\r\n    const [fetchedTasks, setFetchedTasks] = useState([]);\r\n    const [projects, setProjects] = useState([]);\r\n    // Single attachment field that handles multiple files (up to 4)\r\n    const [attachments, setAttachments] = useState([]);\r\n    const [attachTimesheet, setAttachTimesheet] = useState(false);\r\n    // Bill period uses `formData.fromDate` and `formData.toDate`\r\n    const [timesheetRef, setTimesheetRef] = useState('');\r\n    const [snackbar, setSnackbar] = useState({\r\n        open: false,\r\n        message: '',\r\n        severity: 'success'\r\n    })\r\n    const [timesheetPreviewData, setTimesheetPreviewData] = useState(null)\r\n    const fromDateInputRef = useRef(null);\r\n    const toDateInputRef = useRef(null);\r\n    const fileInputRef = useRef(null);\r\n\r\n    const getMonthDiff = (d1, d2) => {\r\n        const date1 = new Date(d1);\r\n        const date2 = new Date(d2);\r\n        let months;\r\n        months = (date2.getFullYear() - date1.getFullYear()) * 12;\r\n        months -= date1.getMonth();\r\n        months += date2.getMonth();\r\n        return months + (date2.getDate() >= date1.getDate() ? 0 : -1);\r\n    };\r\n\r\n    // ...existing code...\r\n    useEffect(() => {\r\n        // Persist draft to sessionStorage so values aren't lost when switching tabs\r\n        try {\r\n            const draft = {\r\n                formData,\r\n                items,\r\n                invoiceEmployees,\r\n                attachments,\r\n                attachTimesheet,\r\n                fetchedTasks\r\n            };\r\n            sessionStorage.setItem('addInvoiceDraft', JSON.stringify(draft));\r\n        } catch (e) {\r\n            // ignore storage errors\r\n        }\r\n    }, [formData, items, invoiceEmployees, attachments, attachTimesheet, fetchedTasks]);\r\n\r\n        const fetchTasksForRange = async () => {\r\n            const selectedRows = (invoiceEmployees || []).filter(e => e.userId);\r\n            if (\r\n                formData.fromDate &&\r\n                formData.toDate &&\r\n                selectedRows.length === 1 &&\r\n                employees.length > 0\r\n            ) {\r\n                const selectedEmployee = employees.find(emp => emp.userId === selectedRows[0].userId);\r\n                if (!selectedEmployee || !selectedEmployee.userId) return;\r\n\r\n                // setFetchingTasks(true);\r\n                try {\r\n                    const res = await axios.get(\r\n                        `${API_BASE_URL}/api/timesheet-tasks/admin-between`,\r\n                        {\r\n                            params: {\r\n                                start: (() => {\r\n                                    const d = new Date(formData.fromDate);\r\n                                    d.setDate(d.getDate() - 1);\r\n                                    return d.toISOString().split('T')[0];\r\n                                })(),\r\n                                end: formData.toDate,\r\n                                userId: selectedEmployee.userId\r\n                            },\r\n                            headers: { Authorization: sessionStorage.getItem(\"token\") }\r\n                        }\r\n                    );\r\n                    setFetchedTasks(res.data || []);\r\n\r\n                    // Calculate total minutes\r\n                    let totalMinutes = 0;\r\n                    (res.data || []).forEach(task => {\r\n                        totalMinutes += (task.hoursSpent || 0) * 60 + (task.minutesSpent || 0);\r\n                    });\r\n                    const hours = Math.floor(totalMinutes / 60);\r\n                    const minutes = totalMinutes % 60;\r\n                    const decimalHours = (hours + minutes / 60).toFixed(2);\r\n\r\n                    // Only auto-populate if user hasn't manually changed hoursSpent\r\n                    setFormData(prev => ({\r\n                        ...prev,\r\n                        hoursSpent: decimalHours\r\n                    }));\r\n\r\n                } catch (error) {\r\n                    console.error('Error fetching tasks:', error);\r\n                    setFetchedTasks([]);\r\n                } finally {\r\n                    // setFetchingTasks(false);\r\n                }\r\n            } else {\r\n                setFetchedTasks([]);\r\n            }\r\n        };\r\n\r\n        fetchTasksForRange();\r\n    }, [formData.fromDate, formData.toDate, employees, invoiceEmployees]);\r\n\r\n\r\n    // ...existing code...\r\n\r\n    // Helper functions for timesheet data processing\r\n    // const formatDate = (date) =>\r\n    //     date.toLocaleDateString(\"en-GB\", { day: \"2-digit\", month: \"short\", year: \"2-digit\" });\r\n\r\n    // const formatDateKey = (date) => date.toISOString().split(\"T\")[0];\r\n\r\n    // const isWeekend = (date) => {\r\n    //     const day = date.getDay();\r\n    //     return day === 0 || day === 6;\r\n    // };\r\n\r\n    // const getWeekDates = (startDate) => {\r\n    //     const dates = [];\r\n    //     for (let i = 0; i < 7; i++) {\r\n    //         const date = new Date(startDate);\r\n    //         date.setDate(startDate.getDate() + i);\r\n    //         dates.push(date);\r\n    //     }\r\n    //     return dates;\r\n    // };\r\n\r\n    // const getMonthDates = () => {\r\n    //     const dates = [];\r\n    //     const current = new Date(currentMonthRange.start);\r\n    //     while (current <= currentMonthRange.end) {\r\n    //         dates.push(new Date(current));\r\n    //         current.setDate(current.getDate() + 1);\r\n    //     }\r\n    //     return dates;\r\n    // };\r\n\r\n    // const getCurrentDates = () => (viewMode === \"Weekly\" ? getWeekDates(currentWeekStart) : getMonthDates());\r\n\r\n    // const getTimeEntries = (date) => {\r\n    //     const dateKey = formatDateKey(date);\r\n    //     return timesheetData[dateKey] || [];\r\n    // };\r\n\r\n    // const getDayTotalTime = (date) => {\r\n    //     const entries = getTimeEntries(date);\r\n    //     let totalMinutes = entries.reduce((total, entry) => {\r\n    //         return total + (entry.hours || 0) * 60 + (entry.minutes || 0);\r\n    //     }, 0);\r\n\r\n    //     const hours = Math.floor(totalMinutes / 60);\r\n    //     const minutes = totalMinutes % 60;\r\n\r\n    //     return { hours, minutes };\r\n    // };\r\n\r\n    // ...existing code...\r\n    const prepareTimesheetData = () => {\r\n        if (!attachTimesheet || !fetchedTasks.length) return null;\r\n\r\n        let totalMinutes = 0;\r\n        const timesheetEntries = fetchedTasks.map(task => {\r\n            totalMinutes += (task.hoursSpent || 0) * 60 + (task.minutesSpent || 0);\r\n            setTimesheetPreviewData([{\r\n                date: task.date, // format as needed\r\n                dayOfWeek: new Date(task.date).toLocaleDateString(\"en-GB\", { weekday: \"short\" }),\r\n                isWeekend: [0, 6].includes(new Date(task.date).getDay()),\r\n                taskType: task.taskType || '',\r\n                taskTopic: task.taskTopic || '',\r\n                hours: task.hoursSpent || 0,\r\n                minutes: task.minutesSpent || 0,\r\n                description: task.description || '',\r\n                project: task.projectName || '',\r\n                submitted: task.submitted || false\r\n            }\r\n            ])\r\n            return {\r\n                date: task.date, // format as needed\r\n                dayOfWeek: new Date(task.date).toLocaleDateString(\"en-GB\", { weekday: \"short\" }),\r\n                isWeekend: [0, 6].includes(new Date(task.date).getDay()),\r\n                taskType: task.taskType || '',\r\n                taskTopic: task.taskTopic || '',\r\n                hours: task.hoursSpent || 0,\r\n                minutes: task.minutesSpent || 0,\r\n                description: task.description || '',\r\n                project: task.projectName || '',\r\n                submitted: task.submitted || false\r\n            };\r\n        });\r\n\r\n        const hours = Math.floor(totalMinutes / 60);\r\n        const minutes = totalMinutes % 60;\r\n        // const decimalHours = parseFloat((hours + minutes / 60).toFixed(2));\r\n\r\n        // Calculate target hours: count working days (Mon-Fri) in the selected range\r\n        let targetHours = 0;\r\n        if (formData.fromDate && formData.toDate) {\r\n            const start = new Date(formData.fromDate);\r\n            const end = new Date(formData.toDate);\r\n            let current = new Date(start);\r\n            while (current <= end) {\r\n                const day = current.getDay();\r\n                if (day !== 0 && day !== 6) { // Mon-Fri\r\n                    targetHours += 8; // or your standard workday hours\r\n                }\r\n                current.setDate(current.getDate() + 1);\r\n            }\r\n        }\r\n\r\n        return {\r\n            viewMode: \"Custom\",\r\n            period: `${formData.fromDate} - ${formData.toDate}`,\r\n            employeeName: formData.employeeName,\r\n            employeeEmail: '', // fill if available\r\n            entries: timesheetEntries,\r\n            totalHours: hours,\r\n            totalMinutes: minutes,\r\n            targetHours // now correctly calculated\r\n        };\r\n    };\r\n    // ...existing code...\r\n\r\n    // Auto-populate employee fields if coming from timesheet (after reset)\r\n    useEffect(() => {\r\n        console.log(employee)\r\n        if (employee && open) {\r\n            // Use setTimeout to ensure this runs after the reset\r\n            setTimeout(() => {\r\n                setFormData(prev => ({\r\n                    ...prev,\r\n                    employeeId: employee.rawData?.userId || employee.id || \"\",\r\n                    employeeName: employee.name || '',\r\n                    rate: employee.rawData?.cost || '',\r\n                    currency: employee.rawData?.unit || employee.rawData?.currency || 'USD'\r\n                }));\r\n            }, 100);\r\n        }\r\n    }, [employee, open]);\r\n\r\n\r\n\r\n    // Generate preview invoice ID for display\r\n    const generatePreviewInvoiceId = () => {\r\n        const today = new Date();\r\n        const month = String(today.getMonth() + 1).padStart(2, '0');\r\n        const day = String(today.getDate()).padStart(2, '0');\r\n        const year = today.getFullYear();\r\n        return `INV-${month}${day}${year}-100001`;\r\n    };\r\n\r\n    const getAttachedFilesCount = () => {\r\n        return attachments.filter(file => file !== null).length;\r\n    };\r\n\r\n    const getTotalFileSize = () => {\r\n        return attachments.reduce((total, file) => total + file.size, 0);\r\n    };\r\n\r\n    const formatFileSize = (bytes) => {\r\n        if (bytes === 0) return '0 Bytes';\r\n        const k = 1024;\r\n        const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n        const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\r\n    };\r\n\r\n    const fetchDropdownData = useCallback(async () => {\r\n        try {\r\n            setLoadingEmployees(true);\r\n\r\n            const tenantId = sessionStorage.getItem(\"tenantId\");\r\n            const token = sessionStorage.getItem(\"token\");\r\n\r\n            if (!tenantId || !token) {\r\n                throw new Error('Missing tenantId or token');\r\n            }\r\n\r\n            const res = await axios.get(\r\n                `${API_BASE_URL}/api/tenants/${tenantId}/users`,\r\n                {\r\n                    headers: { Authorization: token }\r\n                }\r\n            );\r\n\r\n            if (!res.data || !Array.isArray(res.data)) {\r\n                throw new Error('Invalid API response structure');\r\n            }\r\n\r\n            // Transform employees data for dropdowns\r\n            const employeeOptions = res.data.map(emp => ({\r\n                label: `${emp.name} ${emp.empCode ? `(${emp.empCode})` : ''}`.trim(),\r\n                value: emp.name,\r\n                empCode: emp.empCode,\r\n                cost: emp.cost,\r\n                email: emp.email,\r\n                userId: emp.userId,\r\n                status: emp.status,\r\n                currency: emp.unit || emp.currency || emp.preferredunit || 'USD',\r\n                city: emp.city,\r\n                state: emp.state,\r\n                country: emp.country,\r\n                mobilePhone: emp.mobilePhone\r\n            }));\r\n\r\n            setEmployees(employeeOptions);\r\n\r\n            // Fetch projects\r\n            await fetchProjects();\r\n\r\n        } catch (error) {\r\n            console.error('Error fetching dropdown data:', error);\r\n            setEmployees([]);\r\n            alert(`Failed to fetch employee data: ${error.message}`);\r\n            setErrors({\r\n                submit: \"Failed to fetch Employees, please try again.\"\r\n            })\r\n        } finally {\r\n            setLoadingEmployees(false);\r\n        }\r\n    }, []);\r\n\r\n    // Initialize dropdown data when modal opens and auto-reset form\r\n    useEffect(() => {\r\n        if (open) {\r\n            fetchDropdownData();\r\n            // Restore draft if present, otherwise initialize\r\n            try {\r\n                const draft = sessionStorage.getItem('addInvoiceDraft');\r\n                if (draft) {\r\n                    const parsed = JSON.parse(draft);\r\n                    if (parsed) {\r\n                        setFormData(parsed.formData || {});\r\n                        setItems(parsed.items || [{ id: 1, description: '', rate: '', quantity: '', amount: '', remarks: '' }]);\r\n                        setInvoiceEmployees(parsed.invoiceEmployees || [{ id: 1, userId: '', rate: '', quantity: '', amount: '', remarks: '' }]);\r\n                        setAttachments(parsed.attachments || []);\r\n                        setAttachTimesheet(parsed.attachTimesheet || false);\r\n                        setFetchedTasks(parsed.fetchedTasks || []);\r\n                        // do not clear draft here\r\n                    } else {\r\n                        handleReset();\r\n                    }\r\n                } else {\r\n                    handleReset();\r\n                }\r\n            } catch (e) {\r\n                console.error('Failed to restore invoice draft:', e);\r\n                handleReset();\r\n            }\r\n        }\r\n    }, [open, fetchDropdownData]);\r\n\r\n    const fetchProjects = async () => {\r\n        try {\r\n            const token = sessionStorage.getItem(\"token\");\r\n            const response = await axios.get(\r\n                `${API_BASE_URL}/api/invoices/projects`,\r\n                {\r\n                    headers: { Authorization: token }\r\n                }\r\n            );\r\n            setProjects(response.data);\r\n        } catch (error) {\r\n            console.error('Error fetching projects:', error);\r\n        }\r\n    };\r\n\r\n    // Auto-calculate total amount when rate or hours change\r\n    useEffect(() => {\r\n        if (formData.rate && formData.hoursSpent) {\r\n            setIsCalculating(true);\r\n            const rate = parseFloat(formData.rate) || 0;\r\n            const hours = parseInt(formData.hoursSpent) || 0;\r\n            const total = rate * hours;\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                totalAmount: total.toFixed(2)\r\n            }));\r\n            setTimeout(() => setIsCalculating(false), 300);\r\n        } else {\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                totalAmount: ''\r\n            }));\r\n        }\r\n    }, [formData.rate, formData.hoursSpent]);\r\n\r\n    const handleChange = (field) => (event) => {\r\n        let value = event.target.value;\r\n        if (field === 'hoursSpent') {\r\n            // Allow only numbers and one decimal point\r\n            value = value.replace(/[^0-9.]/g, '');\r\n            // Prevent multiple decimals\r\n            const parts = value.split('.');\r\n            if (parts.length > 2) {\r\n                value = parts[0] + '.' + parts.slice(1).join('');\r\n            }\r\n        }\r\n        setFormData(prev => {\r\n            let updated = { ...prev, [field]: value };\r\n\r\n            // ...existing fromDate/toDate validation logic...\r\n            if (field === 'fromDate' && prev.toDate) {\r\n                if (new Date(prev.toDate) < new Date(value) ||\r\n                    getMonthDiff(value, prev.toDate) > 1 ||\r\n                    (getMonthDiff(value, prev.toDate) === 1 && new Date(prev.toDate).getDate() > new Date(value).getDate())\r\n                ) {\r\n                    updated.toDate = '';\r\n                }\r\n                // update billPeriod when both dates available\r\n                if (updated.fromDate && updated.toDate) {\r\n                    updated.billPeriod = `${updated.fromDate} - ${updated.toDate}`;\r\n                } else {\r\n                    updated.billPeriod = '';\r\n                }\r\n            }\r\n            if (field === 'toDate' && prev.fromDate) {\r\n                if (new Date(value) < new Date(prev.fromDate) ||\r\n                    getMonthDiff(prev.fromDate, value) > 1 ||\r\n                    (getMonthDiff(prev.fromDate, value) === 1 && new Date(value).getDate() > new Date(prev.fromDate).getDate())\r\n                ) {\r\n                    return prev;\r\n                }\r\n                // update billPeriod when both dates available\r\n                if (updated.fromDate && updated.toDate) {\r\n                    updated.billPeriod = `${updated.fromDate} - ${updated.toDate}`;\r\n                } else {\r\n                    updated.billPeriod = '';\r\n                }\r\n            }\r\n            return updated;\r\n        });\r\n        if (errors[field]) {\r\n            setErrors(prev => ({ ...prev, [field]: '' }));\r\n        }\r\n    };\r\n\r\n    // const handleSelectChange = (field) => (selectedOption) => {\r\n    //     setFormData(prev => ({\r\n    //         ...prev,\r\n    //         [field]: selectedOption?.value || ''\r\n    //     }));\r\n    //     if (errors[field]) {\r\n    //         setErrors(prev => ({ ...prev, [field]: '' }));\r\n    //     }\r\n    // };\r\n\r\n    // Handler for customer organization selection with full details\r\n    const handleCustomerOrgSelect = (orgData) => {\r\n        if (orgData) {\r\n            // Build address from organization data\r\n            let addressParts = [];\r\n            if (orgData.orgAddress) addressParts.push(orgData.orgAddress);\r\n            if (orgData.orgCity) addressParts.push(orgData.orgCity);\r\n            if (orgData.orgState) addressParts.push(orgData.orgState);\r\n            if (orgData.orgCountry) addressParts.push(orgData.orgCountry);\r\n            if (orgData.orgZip) addressParts.push(orgData.orgZip);\r\n\r\n            const finalAddress = addressParts.length > 0 ? addressParts.join(', ') : '';\r\n\r\n            // Build info string with GST/Tax details\r\n            let infoParts = [];\r\n            if (orgData.orgTaxName) infoParts.push(`GST/Tax Name: ${orgData.orgTaxName}`);\r\n            if (orgData.orgTaxId) infoParts.push(`Tax ID: ${orgData.orgTaxId}`);\r\n            if (orgData.orgDesc) infoParts.push(`Description: ${orgData.orgDesc}`);\r\n\r\n            const finalInfo = infoParts.length > 0 ? infoParts.join(' | ') : '';\r\n\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                billToAddress: finalAddress,\r\n                shipToAddress: finalAddress,\r\n                customerInfo: finalInfo\r\n            }));\r\n        } else {\r\n            // Clear related fields when customer is cleared\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                billToAddress: '',\r\n                shipToAddress: '',\r\n                customerInfo: ''\r\n            }));\r\n        }\r\n    };\r\n\r\n    // Handler for supplier organization selection with full details\r\n    const handleSupplierOrgSelect = (orgData) => {\r\n        if (orgData) {\r\n            // Build address from organization data\r\n            let addressParts = [];\r\n            if (orgData.orgAddress) addressParts.push(orgData.orgAddress);\r\n            if (orgData.orgCity) addressParts.push(orgData.orgCity);\r\n            if (orgData.orgState) addressParts.push(orgData.orgState);\r\n            if (orgData.orgCountry) addressParts.push(orgData.orgCountry);\r\n            if (orgData.orgZip) addressParts.push(orgData.orgZip);\r\n\r\n            const finalAddress = addressParts.length > 0 ? addressParts.join(', ') : '';\r\n\r\n            // Build info string with GST/Tax details\r\n            let infoParts = [];\r\n            if (orgData.orgTaxName) infoParts.push(`GST/Tax Name: ${orgData.orgTaxName}`);\r\n            if (orgData.orgTaxId) infoParts.push(`Tax ID: ${orgData.orgTaxId}`);\r\n            if (orgData.orgDesc) infoParts.push(`Description: ${orgData.orgDesc}`);\r\n\r\n            const finalInfo = infoParts.length > 0 ? infoParts.join(' | ') : '';\r\n\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                supplierAddress: finalAddress,\r\n                supplierInfo: finalInfo\r\n            }));\r\n        } else {\r\n            // Clear related fields when supplier is cleared\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                supplierAddress: '',\r\n                supplierInfo: ''\r\n            }));\r\n        }\r\n    };\r\n\r\n    // Special handler for employee selection to auto-populate rate and currency\r\n    const handleEmployeeChange = (selected) => {\r\n        // selected can be null, a single option, or an array when isMulti is enabled\r\n        if (!selected) {\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                employeeId: '',\r\n                employeeName: '',\r\n                employeeNames: [],\r\n                employeeIds: [],\r\n                rate: '',\r\n                currency: 'USD'\r\n            }));\r\n            return;\r\n        }\r\n\r\n        if (Array.isArray(selected)) {\r\n            const names = selected.map(s => s.value);\r\n            const ids = selected.map(s => s.userId);\r\n            // If multiple employees selected, clear timesheet attachment state\r\n            if (names.length > 1 && attachTimesheet) setAttachTimesheet(false);\r\n\r\n            // Keep rate/currency from the first selected employee if available\r\n            const first = selected[0];\r\n            const newCurrency = first.currency || 'USD';\r\n            const newRate = first.cost || '';\r\n\r\n            setFormData(prev => ({\r\n                ...prev,\r\n                employeeName: names.length === 1 ? names[0] : '',\r\n                employeeId: ids.length === 1 ? ids[0] : '',\r\n                employeeNames: names,\r\n                employeeIds: ids,\r\n                rate: newRate,\r\n                currency: newCurrency\r\n            }));\r\n            return;\r\n        }\r\n\r\n        // Single selection (object)\r\n        const newCurrency = selected.currency || 'USD';\r\n        const newRate = selected.cost || '';\r\n        setFormData(prev => ({\r\n            ...prev,\r\n            employeeId: selected.userId || '',\r\n            employeeName: selected.value,\r\n            employeeNames: [selected.value],\r\n            employeeIds: [selected.userId],\r\n            rate: newRate,\r\n            currency: newCurrency\r\n        }));\r\n\r\n        if (errors.rate) {\r\n            setErrors(prev => ({ ...prev, rate: '' }));\r\n        }\r\n    };\r\n\r\n    // Handle multiple file selection (up to 4 files)\r\n    const handleFileChange = (event) => {\r\n        const files = Array.from(event.target.files);\r\n\r\n        if (files.length > 4) {\r\n            alert('You can attach a maximum of 4 files at once.');\r\n            return;\r\n        }\r\n\r\n        // Validate each file\r\n        const validFiles = [];\r\n        const allowedTypes = [\r\n            'application/pdf',\r\n            'application/msword',\r\n            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\r\n            'text/plain',\r\n            'image/jpeg',\r\n            'image/jpg',\r\n            'image/png',\r\n            'image/gif'\r\n        ];\r\n\r\n        for (let file of files) {\r\n            // Validate file size (10MB limit)\r\n            if (file.size > 10 * 1024 * 1024) {\r\n                alert(`File \"${file.name}\" exceeds 10MB limit and will be skipped.`);\r\n                continue;\r\n            }\r\n\r\n            // Validate file type\r\n            if (!allowedTypes.includes(file.type)) {\r\n                alert(`File \"${file.name}\" has unsupported format and will be skipped. Please upload PDF, DOC, DOCX, TXT, or image files.`);\r\n                continue;\r\n            }\r\n\r\n            validFiles.push(file);\r\n        }\r\n\r\n        setAttachments(validFiles);\r\n    };\r\n\r\n    // ------- Table & Employee row handlers -------\r\n    const updateTableHeader = (key, value) => {\r\n        setTableHeaders(prev => ({ ...prev, [key]: value }));\r\n    };\r\n\r\n    const updateItemField = (id, field, value) => {\r\n        setItems(prev => prev.map(it => {\r\n            if (it.id !== id) return it;\r\n            const next = { ...it, [field]: value };\r\n            // recalc amount when rate or quantity change\r\n            const rate = parseFloat(next.rate) || 0;\r\n            const qty = parseFloat(next.quantity) || 0;\r\n            next.amount = (rate * qty).toFixed(2);\r\n            return next;\r\n        }));\r\n    };\r\n\r\n    const addItem = () => {\r\n        if (items.length >= 5) return setSnackbar({ open: true, message: 'Maximum 5 items allowed', severity: 'error' });\r\n        const nextId = items.length ? Math.max(...items.map(i => i.id)) + 1 : 1;\r\n        setItems(prev => ([...prev, { id: nextId, description: '', rate: '', quantity: '', amount: '', remarks: '' }]));\r\n    };\r\n\r\n    const removeItem = (id) => {\r\n        if (items.length <= 1) return; // keep at least one item\r\n        setItems(prev => prev.filter(i => i.id !== id));\r\n    };\r\n\r\n    const addEmployeeRow = () => {\r\n        if (invoiceEmployees.length >= 5) return setSnackbar({ open: true, message: 'Maximum 5 employees allowed', severity: 'error' });\r\n        const nextId = invoiceEmployees.length ? Math.max(...invoiceEmployees.map(i => i.id)) + 1 : 1;\r\n        setInvoiceEmployees(prev => ([...prev, { id: nextId, userId: '', rate: '', quantity: '', amount: '', remarks: '' }]));\r\n    };\r\n\r\n    const removeEmployeeRow = (id) => {\r\n        if (invoiceEmployees.length <= 1) return; // keep at least one row\r\n        setInvoiceEmployees(prev => prev.filter(e => e.id !== id));\r\n    };\r\n\r\n    const updateEmployeeRow = (id, field, value) => {\r\n        setInvoiceEmployees(prev => {\r\n            const next = prev.map(e => e.id === id ? { ...e, [field]: value } : e);\r\n            const selectedCount = next.filter(e => e.userId).length;\r\n            if (selectedCount !== 1 && attachTimesheet) setAttachTimesheet(false);\r\n            // Recalculate amount for the updated row if rate/quantity changed\r\n            return next.map(e => {\r\n                if (e.id !== id) return e;\r\n                const rate = parseFloat(e.rate) || 0;\r\n                const qty = parseFloat(e.quantity) || 0;\r\n                return { ...e, amount: (rate * qty).toFixed(2) };\r\n            });\r\n        });\r\n    };\r\n\r\n    // Ensure timesheet checkbox is disabled when selected employees count is not exactly one\r\n    useEffect(() => {\r\n        const selectedCount = (invoiceEmployees || []).filter(e => e.userId).length;\r\n        if (selectedCount !== 1 && attachTimesheet) {\r\n            setAttachTimesheet(false);\r\n        }\r\n    }, [invoiceEmployees, attachTimesheet]);\r\n\r\n    const computeItemsTotal = () => {\r\n        const itemsTotal = items.reduce((s, it) => s + (parseFloat(it.amount) || 0), 0);\r\n        const empTotal = (invoiceEmployees || []).reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);\r\n        return (itemsTotal + empTotal).toFixed(2);\r\n    };\r\n\r\n    const removeAttachment = (index) => {\r\n        const newAttachments = [...attachments];\r\n        newAttachments.splice(index, 1);\r\n        setAttachments(newAttachments);\r\n    };\r\n\r\n    const removeAllAttachments = () => {\r\n        setAttachments([]);\r\n        if (fileInputRef.current) {\r\n            fileInputRef.current.value = '';\r\n        }\r\n    };\r\n\r\n    const validateForm = () => {\r\n        const newErrors = {};\r\n\r\n        // Invoice name is now optional - no validation needed\r\n        if (!formData.customerName.trim()) newErrors.customerName = 'Customer name is required';\r\n        if (!formData.supplierName.trim()) newErrors.supplierName = 'Supplier name is required';\r\n        // Allow empty items or employees tables, but require combined table total > 0\r\n        const combinedTotal = parseFloat(computeItemsTotal()) || 0;\r\n        if (combinedTotal <= 0) newErrors.items = 'At least one item or employee row must have a non-zero amount';\r\n\r\n        // Make fromDate, toDate and hours optional in the new form.\r\n        // Only validate date range when both dates are provided.\r\n        if (formData.fromDate && formData.toDate && new Date(formData.toDate) < new Date(formData.fromDate)) {\r\n            newErrors.toDate = 'To date must be after from date';\r\n        }\r\n\r\n        // Validate character limits\r\n        if (formData.billToAddress && formData.billToAddress.length > 500) {\r\n            newErrors.billToAddress = 'Bill To address cannot exceed 500 characters';\r\n        }\r\n        if (formData.shipToAddress && formData.shipToAddress.length > 500) {\r\n            newErrors.shipToAddress = 'Ship To address cannot exceed 500 characters';\r\n        }\r\n        if (formData.customerInfo && formData.customerInfo.length > 100) {\r\n            newErrors.customerInfo = 'Customer info cannot exceed 100 characters';\r\n        }\r\n        if (formData.supplierAddress && formData.supplierAddress.length > 500) {\r\n            newErrors.supplierAddress = 'Supplier address cannot exceed 500 characters';\r\n        }\r\n        if (formData.supplierInfo && formData.supplierInfo.length > 100) {\r\n            newErrors.supplierInfo = 'Supplier info cannot exceed 100 characters';\r\n        }\r\n\r\n        setErrors(newErrors);\r\n        return Object.keys(newErrors).length === 0;\r\n    };\r\n\r\n    const handleSubmit = async () => {\r\n        console.log('handleSubmit called');\r\n        if (!validateForm()) {\r\n            console.log('validateForm failed', errors);\r\n            setSnackbar({ open: true, message: 'Please fix validation errors before submitting.', severity: 'error' });\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            const tableTotal = items && items.length ? parseFloat(computeItemsTotal()) : null;\r\n\r\n            // Normalize numeric fields to avoid null/NaN being sent to backend\r\n            const parsedRate = parseFloat(formData.rate);\r\n            const rateValue = Number.isFinite(parsedRate) ? parsedRate : null;\r\n            const parsedHours = parseFloat(formData.hoursSpent);\r\n            const hoursValue = Number.isFinite(parsedHours) ? parsedHours : null;\r\n\r\n            const itemsToSend = (items || []).map(it => ({\r\n                ...it,\r\n                rate: Number.isFinite(parseFloat(it.rate)) ? parseFloat(it.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(it.quantity)) ? parseFloat(it.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(it.amount)) ? parseFloat(it.amount) : 0\r\n            }));\r\n\r\n            const employeesToSend = (invoiceEmployees || []).filter(e => e.userId).map(e => ({\r\n                ...e,\r\n                rate: Number.isFinite(parseFloat(e.rate)) ? parseFloat(e.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(e.quantity)) ? parseFloat(e.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(e.amount)) ? parseFloat(e.amount) : 0\r\n            }));\r\n\r\n            const invoiceData = {\r\n                invoiceName: formData.invoiceName,\r\n                invoiceType: formData.invoiceType,\r\n                invoiceDate: formData.invoiceDate,\r\n                taxId: formData.taxId,\r\n                billPeriod: formData.billPeriod,\r\n                customerName: formData.customerName,\r\n                billToAddress: formData.billToAddress || \"\",\r\n                shipToAddress: formData.shipToAddress || \"\",\r\n                customerInfo: formData.customerInfo || \"\",\r\n                supplierName: formData.supplierName,\r\n                supplierAddress: formData.supplierAddress || \"\",\r\n                supplierInfo: formData.supplierInfo || \"\",\r\n                items: itemsToSend,\r\n                invoiceEmployees: employeesToSend,\r\n                employeeName: formData.employeeName,\r\n                employeeNames: formData.employeeNames && formData.employeeNames.length ? formData.employeeNames : null,\r\n                currency: formData.currency,\r\n                fromDate: formData.fromDate,\r\n                toDate: formData.toDate,\r\n                hoursSpent: hoursValue,\r\n                totalAmount: tableTotal !== null ? tableTotal : (formData.totalAmount ? parseFloat(formData.totalAmount) : null),\r\n                remarks: formData.remarks || \"\",\r\n                projectName: formData.projectName || \"\",\r\n                // Include timesheet data if checkbox is checked AND invoice has a single employee selected\r\n                timesheetData: (attachTimesheet && (invoiceEmployees || []).filter(e => e.userId).length === 1) ? prepareTimesheetData() : null\r\n            };\r\n            // Only include top-level rate when we have a positive value or can infer from a single employee\r\n            const singleEmpWithRate = employeesToSend.length === 1 && employeesToSend[0].rate && employeesToSend[0].rate > 0;\r\n            if (rateValue !== null && rateValue > 0) {\r\n                invoiceData.rate = rateValue;\r\n            } else if (singleEmpWithRate) {\r\n                invoiceData.rate = employeesToSend[0].rate;\r\n            }\r\n            console.log('Submitting invoice data:', invoiceData);\r\n            setSnackbar({ open: true, message: 'Submitting invoice...', severity: 'info' });\r\n\r\n            let response;\r\n            if (attachments.length > 0) {\r\n                // Create FormData for multipart request\r\n                const formDataToSend = new FormData();\r\n                formDataToSend.append('invoice', JSON.stringify(invoiceData));\r\n\r\n                // Add attachments to FormData\r\n                attachments.forEach((file) => {\r\n                    formDataToSend.append('attachments', file);\r\n                });\r\n\r\n                response = await axios.post(\r\n                    `${API_BASE_URL}/api/invoices/generate-with-attachments`,\r\n                    formDataToSend,\r\n                    {\r\n                        headers: {\r\n                            Authorization: sessionStorage.getItem(\"token\"),\r\n                            \"Content-Type\": \"multipart/form-data\"\r\n                        }\r\n                    }\r\n                );\r\n            } else {\r\n                // Regular JSON request without attachments\r\n                response = await axios.post(\r\n                    `${API_BASE_URL}/api/invoices/generate`,\r\n                    invoiceData,\r\n                    {\r\n                        headers: {\r\n                            Authorization: sessionStorage.getItem(\"token\"),\r\n                            \"Content-Type\": \"application/json\"\r\n                        }\r\n                    }\r\n                );\r\n            }\r\n\r\n            console.log(isFromInvoiceManagement ? 'Invoice saved successfully:' : 'Invoice generated successfully:', response.data);\r\n            setSnackbar((prev) => ({\r\n                ...prev,\r\n                open: true,\r\n                message: isFromInvoiceManagement ? \"Invoice Saved Successfully\" : \"PO Consumption Created Successfully\",\r\n                severity: \"success\",\r\n            }))\r\n\r\n\r\n            // Call parent's onSubmit if provided\r\n            if (onSubmit) {\r\n                onSubmit(response.data);\r\n            }\r\n\r\n            // Ask user if they want to download the PDF only when NOT from invoice management\r\n            if (!isFromInvoiceManagement && response.data.invoiceId) {\r\n                setTimeout(() => {\r\n                    handleDownloadInvoice(response.data.invoiceId, response.data.invoiceName);\r\n                }, 500);\r\n            }\r\n\r\n            // clear draft and reset\r\n            try { sessionStorage.removeItem('addInvoiceDraft'); } catch (e) {}\r\n            handleReset();\r\n            onClose();\r\n\r\n        } catch (error) {\r\n            console.error('Error creating invoice:', error);\r\n\r\n            let errorMessage = isFromInvoiceManagement ? 'Failed to save invoice. Please try again.' : 'Failed to create invoice. Please try again.';\r\n            setErrors({\r\n                submit: errorMessage\r\n            })\r\n            if (error.response?.data) {\r\n                if (typeof error.response.data === 'string') {\r\n                    errorMessage = error.response.data;\r\n                } else if (error.response.data.message) {\r\n                    errorMessage = error.response.data.message;\r\n                }\r\n            }\r\n\r\n            setSnackbar((prev) => ({\r\n                ...prev,\r\n                open: true,\r\n                message: errorMessage,\r\n                severity: \"error\",\r\n            }))\r\n\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n    const handleInvoicePreview = async () => {\r\n        try {\r\n            const tableTotal = items && items.length ? parseFloat(computeItemsTotal()) : null;\r\n\r\n            const parsedRate = parseFloat(formData.rate);\r\n            const rateValue = Number.isFinite(parsedRate) ? parsedRate : 0;\r\n            const parsedHours = parseFloat(formData.hoursSpent);\r\n            const hoursValue = Number.isFinite(parsedHours) ? parsedHours : 0;\r\n\r\n            const itemsToSend = (items || []).map(it => ({\r\n                ...it,\r\n                rate: Number.isFinite(parseFloat(it.rate)) ? parseFloat(it.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(it.quantity)) ? parseFloat(it.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(it.amount)) ? parseFloat(it.amount) : 0\r\n            }));\r\n\r\n            const employeesToSend = (invoiceEmployees || []).filter(e => e.userId).map(e => ({\r\n                ...e,\r\n                rate: Number.isFinite(parseFloat(e.rate)) ? parseFloat(e.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(e.quantity)) ? parseFloat(e.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(e.amount)) ? parseFloat(e.amount) : 0\r\n            }));\r\n\r\n            const invoiceData = {\r\n                invoiceName: formData.invoiceName || \"\",\r\n                invoiceType: formData.invoiceType,\r\n                invoiceDate: formData.invoiceDate || \"\",\r\n                taxId: formData.taxId || \"\",\r\n                billPeriod: formData.billPeriod || \"\",\r\n                customerName: formData.customerName || \"\",\r\n                billToAddress: formData.billToAddress || \"\",\r\n                shipToAddress: formData.shipToAddress || \"\",\r\n                customerInfo: formData.customerInfo || \"\",\r\n                supplierName: formData.supplierName || \"\",\r\n                supplierAddress: formData.supplierAddress || \"\",\r\n                supplierInfo: formData.supplierInfo || \"\",\r\n                items: itemsToSend,\r\n                invoiceEmployees: employeesToSend,\r\n                employeeName: formData.employeeName || \"\",\r\n                employeeNames: formData.employeeNames && formData.employeeNames.length ? formData.employeeNames : null,\r\n                rate: rateValue,\r\n                currency: formData.currency || \"\",\r\n                fromDate: formData.fromDate || \"\",\r\n                toDate: formData.toDate || \"\",\r\n                hoursSpent: hoursValue,\r\n                totalAmount: tableTotal !== null ? tableTotal : (formData.totalAmount ? parseFloat(formData.totalAmount) : null),\r\n                remarks: formData.remarks || \"\",\r\n                projectName: formData.projectName || \"\",\r\n                // Include timesheet data if checkbox is checked AND invoice has a single employee selected\r\n                timesheetData: (attachTimesheet && (invoiceEmployees || []).filter(e => e.userId).length === 1) ? prepareTimesheetData() : null\r\n            };\r\n            // Only include top-level rate when we have a positive value or can infer from a single employee\r\n            const parsedRate = parseFloat(formData.rate);\r\n            const rateValue = Number.isFinite(parsedRate) ? parsedRate : null;\r\n            const itemsToSend = (items || []).map(it => ({\r\n                ...it,\r\n                rate: Number.isFinite(parseFloat(it.rate)) ? parseFloat(it.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(it.quantity)) ? parseFloat(it.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(it.amount)) ? parseFloat(it.amount) : 0\r\n            }));\r\n            const employeesToSend = (invoiceEmployees || []).filter(e => e.userId).map(e => ({\r\n                ...e,\r\n                rate: Number.isFinite(parseFloat(e.rate)) ? parseFloat(e.rate) : 0,\r\n                quantity: Number.isFinite(parseFloat(e.quantity)) ? parseFloat(e.quantity) : 0,\r\n                amount: Number.isFinite(parseFloat(e.amount)) ? parseFloat(e.amount) : 0\r\n            }));\r\n            if (rateValue !== null && rateValue > 0) {\r\n                invoiceData.rate = rateValue;\r\n            } else if (employeesToSend.length === 1 && employeesToSend[0].rate > 0) {\r\n                invoiceData.rate = employeesToSend[0].rate;\r\n            }\r\n            invoiceData.items = itemsToSend;\r\n            invoiceData.invoiceEmployees = employeesToSend;\r\n            const response = await axios.post(\r\n                `${API_BASE_URL}/api/invoices/preview`,\r\n                invoiceData,\r\n                {\r\n                    headers: {\r\n                        Authorization: sessionStorage.getItem(\"token\"),\r\n                        \"Content-Type\": \"application/json\"\r\n                    },\r\n                    responseType: 'blob'\r\n                }\r\n            )\r\n            const blob = new Blob([response.data], { type: 'application/pdf' });\r\n            const url = window.URL.createObjectURL(blob);\r\n\r\n            // --- Download ---\r\n            const link = document.createElement('a');\r\n            link.href = url;\r\n            link.download = `invoicepreview.pdf`;\r\n            document.body.appendChild(link);\r\n            link.click();\r\n            document.body.removeChild(link);\r\n\r\n            // --- Open in new tab ---\r\n            window.open(url, '_blank');\r\n\r\n            // Cleanup after a short delay (so the object URL is still valid for the new tab)\r\n            setTimeout(() => {\r\n                window.URL.revokeObjectURL(url);\r\n            }, 5000);\r\n\r\n            console.log(response.data)\r\n\r\n        } catch (error) {\r\n            console.error(\"Failed to preview invoice:\", error);\r\n        }\r\n    }\r\n    const handleDownloadInvoice = async (invoiceId, invoiceName) => {\r\n        try {\r\n            const response = await axios.get(\r\n                `${API_BASE_URL}/api/invoices/download/${invoiceId}`,\r\n                {\r\n                    headers: {\r\n                        Authorization: sessionStorage.getItem(\"token\")\r\n                    },\r\n                    responseType: 'blob'\r\n                }\r\n            );\r\n\r\n            const blob = new Blob([response.data], { type: 'application/pdf' });\r\n            const url = window.URL.createObjectURL(blob);\r\n\r\n            // --- Download ---\r\n            const link = document.createElement('a');\r\n            link.href = url;\r\n            link.download = `${invoiceName || invoiceId}.pdf`;\r\n            document.body.appendChild(link);\r\n            link.click();\r\n            document.body.removeChild(link);\r\n\r\n            // --- Open in new tab ---\r\n            window.open(url, '_blank');\r\n\r\n            // Cleanup after a short delay (so the object URL is still valid for the new tab)\r\n            setTimeout(() => {\r\n                window.URL.revokeObjectURL(url);\r\n            }, 5000);\r\n\r\n        } catch (error) {\r\n            console.error(\"Failed to download invoice:\", error);\r\n            setSnackbar((prev) => ({\r\n                ...prev,\r\n                open: true,\r\n                message: \"Failed to download invoice. Please try again.\",\r\n                severity: \"error\",\r\n            }))\r\n        }\r\n    };\r\n\r\n\r\n    const handleReset = () => {\r\n        setFormData({\r\n            invoiceName: '',\r\n            customerName: '',\r\n            billToAddress: '',\r\n            shipToAddress: '',\r\n            customerInfo: '',\r\n            supplierName: sessionStorage.getItem('tenantName') || '',\r\n            supplierAddress: '',\r\n            supplierInfo: '',\r\n            employeeName: '',\r\n            employeeNames: [],\r\n            employeeIds: [],\r\n            rate: '',\r\n            currency: 'USD',\r\n            fromDate: '',\r\n            toDate: '',\r\n            hoursSpent: '',\r\n            totalAmount: '',\r\n            remarks: '',\r\n            projectName: '',\r\n            employeeId: ''\r\n        });\r\n        setErrors({});\r\n        setAttachments([]);\r\n        setAttachTimesheet(false);\r\n        setFetchedTasks([]);\r\n        if (fileInputRef.current) {\r\n            fileInputRef.current.value = '';\r\n        }\r\n        // clear saved draft\r\n        try { sessionStorage.removeItem('addInvoiceDraft'); } catch (e) { }\r\n    };\r\n\r\n    const getDisplayTotal = () => {\r\n        if (isCalculating) return 'Calculating...';\r\n        // Prefer table total if items are present\r\n        if (items && items.length > 0) {\r\n            const total = computeItemsTotal();\r\n            const symbol = currencySymbols[formData.currency] || '$';\r\n            return `${symbol}${parseFloat(total || 0).toLocaleString()}`;\r\n        }\r\n        if (formData.totalAmount) {\r\n            const symbol = currencySymbols[formData.currency] || '$';\r\n            return `${symbol}${parseFloat(formData.totalAmount).toLocaleString()}`;\r\n        }\r\n        return `${currencySymbols[formData.currency] || '$'}0.00`;\r\n    };\r\n\r\n    const amountToWords = (amountValue, currency) => {\r\n        if (amountValue === null || amountValue === undefined || isNaN(amountValue)) return '';\r\n        const units = ['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];\r\n        const tens = ['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];\r\n\r\n        const numberToWords = (n) => {\r\n            if (n === 0) return 'Zero';\r\n            if (n < 20) return units[n];\r\n            if (n < 100) return tens[Math.floor(n/10)] + (n%10 ? ' ' + units[n%10] : '');\r\n            if (n < 1000) return units[Math.floor(n/100)] + ' Hundred' + (n%100 ? ' ' + numberToWords(n%100) : '');\r\n            if (n < 1000000) return numberToWords(Math.floor(n/1000)) + ' Thousand' + (n%1000 ? ' ' + numberToWords(n%1000) : '');\r\n            if (n < 1000000000) return numberToWords(Math.floor(n/1000000)) + ' Million' + (n%1000000 ? ' ' + numberToWords(n%1000000) : '');\r\n            return numberToWords(Math.floor(n/1000000000)) + ' Billion' + (n%1000000000 ? ' ' + numberToWords(n%1000000000) : '');\r\n        };\r\n\r\n        const major = {\r\n            USD: ['Dollar','Cent'],\r\n            INR: ['Rupee','Paise'],\r\n            EUR: ['Euro','Cent'],\r\n            GBP: ['Pound','Pence'],\r\n            JPY: ['Yen','Sen'],\r\n            CAD: ['Dollar','Cent'],\r\n            AUD: ['Dollar','Cent']\r\n        };\r\n\r\n        const amt = parseFloat(amountValue) || 0;\r\n        const whole = Math.floor(Math.abs(amt));\r\n        const fraction = Math.round((Math.abs(amt) - whole) * 100);\r\n        const majorName = (major[currency] && major[currency][0]) || 'Currency';\r\n        const minorName = (major[currency] && major[currency][1]) || 'Cents';\r\n\r\n        let words = numberToWords(whole) + ' ' + (whole === 1 ? majorName : (majorName + 's'));\r\n        if (fraction > 0) {\r\n            words += ' and ' + numberToWords(fraction) + ' ' + (fraction === 1 ? minorName : (minorName));\r\n        }\r\n        return words;\r\n    };\r\n\r\n    const getTimesheetSummary = () => {\r\n        if (!attachTimesheet || !fetchedTasks.length) return null;\r\n\r\n        let totalMinutes = 0;\r\n        let taskCount = fetchedTasks.length;\r\n\r\n        fetchedTasks.forEach(task => {\r\n            totalMinutes += (task.hoursSpent || 0) * 60 + (task.minutesSpent || 0);\r\n        });\r\n\r\n        const totalHours = Math.floor(totalMinutes / 60);\r\n        const totalMinutesRemainder = totalMinutes % 60;\r\n\r\n        return {\r\n            period: \"Custom\",\r\n            totalHours,\r\n            totalMinutes: totalMinutesRemainder,\r\n            taskCount,\r\n            dateRange: `${formData.fromDate} - ${formData.toDate}`\r\n        };\r\n    };\r\n\r\n    if (!open) return null;\r\n\r\n    return (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center backdrop-blur-sm p-2 sm:p-4 lg:p-6\">\r\n            <div className=\"bg-white rounded-lg shadow-xl w-full max-w-xs sm:max-w-2xl md:max-w-4xl lg:max-w-6xl xl:max-w-7xl max-h-[95vh] overflow-hidden flex flex-col\">\r\n                {/* Header */}\r\n                <div className=\"bg-green-600 text-white rounded-t-lg\">\r\n                    <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0 p-4 sm:p-6\">\r\n                        <div className=\"flex items-center space-x-2 sm:space-x-3\">\r\n                            <div className=\"w-8 h-8 bg-green-700 rounded-lg flex items-center justify-center\">\r\n                                <FileText className=\"w-5 h-5 text-white\" />\r\n                            </div>\r\n                            <div>\r\n                                <h2 className=\"text-base sm:text-lg lg:text-xl font-bold\">Add New Invoice</h2>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"flex items-center space-x-3\">\r\n                            {/* Tenant logo or initials on top-right */}\r\n                            <div className=\"flex items-center space-x-3\">\r\n                                {(() => {\r\n                                    const logoUrl = sessionStorage.getItem('tenantLogoUrl');\r\n                                    const tenantName = sessionStorage.getItem('tenantName') || '';\r\n                                    if (logoUrl) {\r\n                                        return <img src={logoUrl} alt=\"tenant-logo\" className=\"w-10 h-10 rounded-md object-cover\" />\r\n                                    }\r\n                                    const initials = tenantName ? (tenantName.trim().charAt(0).toUpperCase() + tenantName.trim().slice(-1).toUpperCase()) : 'TN';\r\n                                    return (\r\n                                        <div className=\"w-10 h-10 bg-white text-green-700 font-bold rounded-md flex items-center justify-center border\">\r\n                                            {initials}\r\n                                        </div>\r\n                                    )\r\n                                })()}\r\n                            </div>\r\n\r\n                            <button\r\n                                onClick={onClose}\r\n                                className=\"p-2 hover:bg-green-700 rounded-full transition-colors cursor-pointer\"\r\n                            >\r\n                                <X className=\"w-5 h-5 text-white\" />\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"p-4 sm:p-6 overflow-y-auto flex-grow\">\r\n                    <div className=\"space-y-6\">\r\n                        {/* 1st Line: Invoice ID, Invoice Name, and Project Name */}\r\n                        {errors.submit && (\r\n                            <div className=\"bg-red-50 border border-red-200 rounded-md p-3 flex items-center\">\r\n                                <AlertCircle size={18} className=\"text-red-500 mr-2\" />\r\n                                <span className=\"text-red-700 text-sm\">{errors.submit}</span>\r\n                            </div>\r\n                        )}\r\n                        {/* New layout per spec */}\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Invoice ID</label>\r\n                                <input type=\"text\" disabled value={generatePreviewInvoiceId()} className=\"w-full h-10 px-4 border border-gray-300 rounded-md bg-gray-50 text-gray-500\" />\r\n                            </div>\r\n\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Supplier Name *</label>\r\n                                <OrganizationSelect\r\n                                    value={formData.supplierName || ''}\r\n                                    onChange={(value) => setFormData(prev => ({ ...prev, supplierName: value }))}\r\n                                    onOrgSelect={handleSupplierOrgSelect}\r\n                                    placeholder=\"Search for supplier or type new...\"\r\n                                    orgType=\"SUPPLIER\"\r\n                                    isDisabled={loadingEmployees}\r\n                                    className=\"w-full\"\r\n                                />\r\n                            </div>\r\n\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Invoice Type</label>\r\n                                <select value={formData.invoiceType} onChange={handleChange('invoiceType')} className=\"w-full h-10 px-4 border border-gray-300 rounded-md\">\r\n                                    <option value=\"DOMESTIC\">Domestic</option>\r\n                                    <option value=\"INTERNATIONAL\">International</option>\r\n                                </select>\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-3  gap-3 sm:gap-4 mt-3\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Invoice Name</label>\r\n                                <input type=\"text\" placeholder=\"Enter invoice name (optional)\" value={formData.invoiceName} onChange={handleChange('invoiceName')} className=\"w-full h-10 px-4 border rounded-md\" maxLength={100} />\r\n                            </div>\r\n\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Supplier Address</label>\r\n                                <input type=\"text\" placeholder=\"Enter supplier address\" value={formData.supplierAddress} onChange={handleChange('supplierAddress')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"grid grid-cols-3 gap-3 sm:gap-4 mt-3\">\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Invoice Date</label>\r\n                                <input type=\"date\" value={formData.invoiceDate} onChange={handleChange('invoiceDate')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                            </div>\r\n\r\n                            <div>\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Tax ID</label>\r\n                                <input type=\"text\" placeholder=\"Enter tax id\" value={formData.taxId} onChange={handleChange('taxId')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                            </div>\r\n                        </div>\r\n\r\n                                    <div className=\"mt-3\">\r\n                                        <label className=\"block text-sm font-medium text-gray-700 mb-2\">Bill Period</label>\r\n                                        <div className=\"grid grid-cols-2 gap-2\">\r\n                                            <div>\r\n                                                <label className=\"text-xs text-gray-600\">From</label>\r\n                                                <input type=\"date\" value={formData.fromDate} onChange={handleChange('fromDate')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <label className=\"text-xs text-gray-600\">To</label>\r\n                                                <input type=\"date\" value={formData.toDate} onChange={handleChange('toDate')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                                            </div>\r\n                                        </div>\r\n                                    </div>\r\n\r\n                        {/* Currency select moved into the Invoice Items table header */}\r\n\r\n                        <div className=\"mt-3\">\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Customer Name *</label>\r\n                            <OrganizationSelect\r\n                                value={formData.customerName || ''}\r\n                                onChange={(value) => setFormData(prev => ({ ...prev, customerName: value }))}\r\n                                onOrgSelect={handleCustomerOrgSelect}\r\n                                placeholder=\"Search for customer or type new...\"\r\n                                orgType=\"CUSTOMER\"\r\n                                isDisabled={loadingEmployees}\r\n                                className=\"w-full\"\r\n                            />\r\n                        </div>\r\n\r\n                        {/* Customer address fields - vary by invoice type */}\r\n                        <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4\">\r\n                            <div className=\"col-span-1\">\r\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">Bill To Address</label>\r\n                                {formData.invoiceType === 'DOMESTIC' ? (\r\n                                    <input type=\"text\" placeholder=\"Bill to address\" value={formData.billToAddress} onChange={handleChange('billToAddress')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                                ) : (\r\n                                    <input type=\"text\" placeholder=\"Customer address (international)\" value={formData.customerInfo} onChange={handleChange('customerInfo')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                                )}\r\n                            </div>\r\n\r\n                            {formData.invoiceType === 'DOMESTIC' && (\r\n                                <div>\r\n                                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">Ship To Address</label>\r\n                                    <input type=\"text\" placeholder=\"Ship to address\" value={formData.shipToAddress} onChange={handleChange('shipToAddress')} className=\"w-full h-10 px-4 border rounded-md\" />\r\n                                </div>\r\n                            )}\r\n\r\n                        </div>\r\n\r\n                        {/* 3rd Line: Supplier Name and Supplier Address */}\r\n                        \r\n\r\n                        \r\n\r\n                        {/* 5th Line: Employee Name, Currency, Rate, Hours Spent */}\r\n\r\n\r\n                        {/* 6th Line: From Date and To Date */}\r\n                          {/* Total Amount Display */}\r\n                        {/* Editable Items / Employees Table */}\r\n                        <div className=\"border border-gray-200 rounded-md p-3 bg-white\">\r\n                            <div className=\"flex items-center justify-between mb-3\">\r\n                                <h3 className=\"text-sm font-semibold\">Invoice Items</h3>\r\n                                <div className=\"flex items-center space-x-2\">\r\n                                    <select value={formData.currency} onChange={handleChange('currency')} className=\"h-8 px-2 border rounded-md text-sm\">\r\n                                        <option value=\"USD\">USD ($)</option>\r\n                                        <option value=\"INR\">INR (₹)</option>\r\n                                        <option value=\"EUR\">EUR (€)</option>\r\n                                        <option value=\"GBP\">GBP (£)</option>\r\n                                        <option value=\"JPY\">JPY (¥)</option>\r\n                                        <option value=\"CAD\">CAD (C$)</option>\r\n                                        <option value=\"AUD\">AUD (A$)</option>\r\n                                    </select>\r\n                                    <button type=\"button\" onClick={() => {\r\n                                        // rename headers example placeholder (no-op)\r\n                                    }} className=\"text-xs text-gray-500\">Edit headers</button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* editable headers */}\r\n                            <div className=\"grid grid-cols-5 gap-0 mb-2\">\r\n                                <input value={tableHeaders.col1} onChange={(e) => updateTableHeader('col1', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                                <input value={tableHeaders.col2} onChange={(e) => updateTableHeader('col2', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                                <input value={tableHeaders.col3} onChange={(e) => updateTableHeader('col3', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                                <input value={tableHeaders.col4} onChange={(e) => updateTableHeader('col4', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                                <input value={tableHeaders.col5} onChange={(e) => updateTableHeader('col5', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                            </div>\r\n\r\n                            {/* Items rows */}\r\n                            <div className=\"space-y-2\">\r\n                                {items.map((it) => (\r\n                                    <div key={it.id} className=\"grid grid-cols-5 gap-0 items-center\">\r\n                                        <input placeholder=\"Description\" value={it.description} onChange={(e) => updateItemField(it.id, 'description', e.target.value)} className=\"px-2 py-1 border rounded-none\" />\r\n                                        <input placeholder=\"Rate\" value={it.rate} onChange={(e) => updateItemField(it.id, 'rate', e.target.value.replace(/[^0-9.]/g, ''))} className=\"px-2 py-1 border rounded-none\" />\r\n                                        <input placeholder=\"Qty\" value={it.quantity} onChange={(e) => updateItemField(it.id, 'quantity', e.target.value.replace(/[^0-9.]/g, ''))} className=\"px-2 py-1 border rounded-none\" />\r\n                                        <input placeholder=\"Amount\" value={it.amount} readOnly className=\"px-2 py-1 border rounded-none bg-gray-50\" />\r\n                                        <div className=\"flex items-center\">\r\n                                            <input placeholder=\"Remarks\" value={it.remarks} onChange={(e) => updateItemField(it.id, 'remarks', e.target.value)} className=\"px-2 py-1 border rounded-none flex-1\" />\r\n                                            <button type=\"button\" onClick={() => removeItem(it.id)} className=\"text-red-500 px-2\" title=\"Delete item\"><Trash2 size={16} /></button>\r\n                                        </div>\r\n                                    </div>\r\n                                ))}\r\n                            </div>\r\n\r\n                            <div className=\"flex gap-2 mt-2\">\r\n                                <button type=\"button\" onClick={addItem} className=\"px-3 py-1 bg-green-600 text-white rounded-md text-sm\">Add Item</button>\r\n                            </div>\r\n\r\n                            {/* Employee selection rows */}\r\n                            <div className=\"mt-4\">\r\n                                <h4 className=\"text-sm font-medium mb-2\">Employees</h4>\r\n                                <div className=\"space-y-2\">\r\n                                    {invoiceEmployees.map((er) => (\r\n                                        <div key={er.id} className=\"grid grid-cols-5 gap-0 items-center\">\r\n                                            <div>\r\n                                                <CreatableSelect\r\n                                                    options={employees}\r\n                                                    value={employees.find(emp => emp.userId === er.userId) || null}\r\n                                                    onChange={(opt) => updateEmployeeRow(er.id, 'userId', opt ? opt.userId : '')}\r\n                                                    classNamePrefix=\"react-select\"\r\n                                                    isClearable\r\n                                                />\r\n                                            </div>\r\n                                            <div>\r\n                                                <input value={er.rate} onChange={(e) => updateEmployeeRow(er.id, 'rate', e.target.value.replace(/[^0-9.]/g, ''))} placeholder=\"Rate\" className=\"px-2 py-1 border rounded-none w-full\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <input value={er.quantity} onChange={(e) => updateEmployeeRow(er.id, 'quantity', e.target.value.replace(/[^0-9.]/g, ''))} placeholder=\"Qty\" className=\"px-2 py-1 border rounded-none w-full\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <input value={er.amount} readOnly placeholder=\"Amount\" className=\"px-2 py-1 border rounded-none bg-gray-50 w-full\" />\r\n                                            </div>\r\n                                            <div className=\"flex items-center\">\r\n                                                <input value={er.remarks} onChange={(e) => updateEmployeeRow(er.id, 'remarks', e.target.value)} placeholder=\"Remarks\" className=\"px-2 py-1 border rounded-none flex-1\" />\r\n                                                <button type=\"button\" onClick={() => removeEmployeeRow(er.id)} className=\"text-red-500 px-2\" title=\"Delete employee\"><Trash2 size={16} /></button>\r\n                                            </div>\r\n                                        </div>\r\n                                    ))}\r\n                                </div>\r\n                                <div className=\"flex gap-2 mt-2\">\r\n                                    <button type=\"button\" onClick={addEmployeeRow} className=\"px-3 py-1 bg-green-600 text-white rounded-md text-sm\">Add Employee</button>\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Table totals and amount in words */}\r\n                            <div className=\"mt-4 text-right\">\r\n                                <div className=\"text-lg font-semibold\">Table Total: {currencySymbols[formData.currency] || '$'}{computeItemsTotal()}</div>\r\n                                <div className=\"text-sm italic mt-1\">In words: {amountToWords(computeItemsTotal(), formData.currency)}</div>\r\n                            </div>\r\n                            {errors.items && (\r\n                                <div className=\"mt-2 text-sm text-red-600\">{errors.items}</div>\r\n                            )}\r\n                            {/* Timesheet checkbox moved below table */}\r\n                            <div className=\"bg-green-50 border border-green-200 rounded-lg p-4 mt-4\">\r\n                                <div className=\"flex items-start space-x-3\">\r\n                                    <input\r\n                                        type=\"checkbox\"\r\n                                        id=\"attachTimesheet\"\r\n                                        checked={attachTimesheet}\r\n                                        onChange={(e) => setAttachTimesheet(e.target.checked)}\r\n                                        disabled={(invoiceEmployees || []).filter(e => e.userId).length > 1}\r\n                                        className=\"w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 mt-0.5\"\r\n                                    />\r\n                                    <div className=\"flex-1\">\r\n                                        <label htmlFor=\"attachTimesheet\" className=\"text-sm font-medium text-green-900 cursor-pointer\">\r\n                                            Include Timesheet Reference in PDF\r\n                                        </label>\r\n                                        <p className=\"text-xs text-green-600 mt-1\">\r\n                                            {viewMode === \"Weekly\"\r\n                                                ? \"Include a detailed weekly timesheet table in the generated invoice PDF\"\r\n                                                : \"Include a detailed monthly timesheet table in the generated invoice PDF\"\r\n                                            }\r\n                                        </p>\r\n                                        {timesheetData && (\r\n                                            <p className=\"text-xs text-green-500 mt-1\">\r\n                                                ✓ Timesheet data available for {viewMode?.toLowerCase() || 'current'} view\r\n                                            </p>\r\n                                        )}\r\n                                        {(invoiceEmployees || []).filter(e => e.userId).length > 1 && (\r\n                                            <p className=\"text-xs text-red-600 mt-1\">Timesheet will not be included when multiple employees are selected</p>\r\n                                        )}\r\n                                    </div>\r\n                                </div>\r\n\r\n                                {/* Timesheet Summary (when timesheet is attached) */}\r\n                                {attachTimesheet && (\r\n                                    <div className=\"mt-3\">\r\n                                        <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-2 mb-2\">\r\n                                            <div>\r\n                                                <label className=\"text-xs text-gray-700\">From</label>\r\n                                                <input type=\"date\" value={formData.fromDate} onChange={handleChange('fromDate')} className=\"w-full h-8 px-2 border rounded-md\" />\r\n                                            </div>\r\n                                            <div>\r\n                                                <label className=\"text-xs text-gray-700\">To</label>\r\n                                                <input type=\"date\" value={formData.toDate} onChange={handleChange('toDate')} className=\"w-full h-8 px-2 border rounded-md\" />\r\n                                            </div>\r\n                                        </div>\r\n                                        <div className=\"flex items-center gap-2\">\r\n                                            <button type=\"button\" onClick={async () => {\r\n                                                // fetch timesheet refs for selected single employee\r\n                                                const selectedRows = (invoiceEmployees || []).filter(e => e.userId);\r\n                                                if (!formData.fromDate || !formData.toDate) {\r\n                                                    setSnackbar({ open: true, message: 'Please select from and to dates in Bill Period', severity: 'error' });\r\n                                                    return;\r\n                                                }\r\n                                                if (selectedRows.length === 0) {\r\n                                                    setSnackbar({ open: true, message: 'Please select an employee row to fetch timesheet for', severity: 'error' });\r\n                                                    return;\r\n                                                }\r\n                                                if (selectedRows.length > 1) {\r\n                                                    setSnackbar({ open: true, message: 'Timesheet auto-fill only available for a single employee', severity: 'error' });\r\n                                                    return;\r\n                                                }\r\n                                                const empId = selectedRows[0].userId;\r\n                                                try {\r\n                                                    const res = await axios.get(`${API_BASE_URL}/api/timesheet-tasks/admin-between`, {\r\n                                                        params: {\r\n                                                            start: formData.fromDate,\r\n                                                            end: formData.toDate,\r\n                                                            userId: empId\r\n                                                        },\r\n                                                        headers: { Authorization: sessionStorage.getItem('token') }\r\n                                                    });\r\n                                                    const tasks = res.data || [];\r\n                                                    setFetchedTasks(tasks);\r\n                                                    // compute total minutes\r\n                                                    let totalMinutes = 0;\r\n                                                    tasks.forEach(task => {\r\n                                                        totalMinutes += (task.hoursSpent || 0) * 60 + (task.minutesSpent || 0);\r\n                                                    });\r\n                                                    const hours = Math.floor(totalMinutes / 60);\r\n                                                    const minutes = totalMinutes % 60;\r\n                                                    const decimalHours = parseFloat((hours + minutes / 60).toFixed(2));\r\n                                                    // set a simple timesheet ref\r\n                                                    const genRef = `TS-${empId}-${formData.fromDate.replace(/-/g,'')}-${formData.toDate.replace(/-/g,'')}`;\r\n                                                    setTimesheetRef(genRef);\r\n                                                    setSnackbar({ open: true, message: `Timesheet fetched (${tasks.length} entries). Ref: ${genRef}`, severity: 'success' });\r\n                                                    // auto-fill the single employee row's quantity and rate\r\n                                                    const empObj = employees.find(e => e.userId === empId);\r\n                                                    setInvoiceEmployees(prev => prev.map(e => e.userId === empId ? ({ ...e, quantity: decimalHours, rate: empObj ? (empObj.cost || empObj.cost === 0 ? empObj.cost : '') : e.rate }) : e));\r\n                                                } catch (err) {\r\n                                                    console.error('Error fetching timesheet tasks:', err);\r\n                                                    setSnackbar({ open: true, message: 'Failed to fetch timesheet data', severity: 'error' });\r\n                                                }\r\n                                            }} className=\"px-3 py-1 bg-green-600 text-white rounded-md text-sm\">Get Timesheet Ref</button>\r\n                                            {timesheetRef && <div className=\"text-sm text-gray-700\">Ref: {timesheetRef}</div>}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                                {attachTimesheet && getTimesheetSummary() && (\r\n                                    <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4\">\r\n                                        <div className=\"flex items-center justify-between mb-3\">\r\n                                            <h3 className=\"text-sm font-semibold text-blue-900 flex items-center\">\r\n                                                <Clock className=\"mr-2\" size={16} />\r\n                                                Timesheet Summary ({getTimesheetSummary().period} View)\r\n                                            </h3>\r\n                                        </div>\r\n                                        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\r\n                                            <div>\r\n                                                <span className=\"text-blue-600 font-medium\">Period:</span>\r\n                                                <p className=\"text-blue-800\">{getTimesheetSummary().dateRange}</p>\r\n                                            </div>\r\n                                            <div>\r\n                                                <span className=\"text-blue-600 font-medium\">Total Hours:</span>\r\n                                                <p className=\"text-blue-800\">{getTimesheetSummary().totalHours}h {getTimesheetSummary().totalMinutes}m</p>\r\n                                            </div>\r\n                                            <div>\r\n                                                <span className=\"text-blue-600 font-medium\">Tasks Logged:</span>\r\n                                                <p className=\"text-blue-800\">{getTimesheetSummary().taskCount} tasks</p>\r\n                                            </div>\r\n                                            <div>\r\n                                                <span className=\"text-blue-600 font-medium\">Employee:</span>\r\n                                                <p className=\"text-blue-800\">{employee?.name || ''}</p>\r\n                                            </div>\r\n                                        </div>\r\n                                        <p className=\"text-xs text-blue-600 mt-2\">\r\n                                            ✓ Detailed timesheet table will be included in the generated PDF\r\n                                        </p>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n\r\n                        <div className=\"bg-green-50 border border-green-200 rounded-lg p-4\">\r\n                            <div className=\"flex items-center justify-between\">\r\n                                <div className=\"flex items-center\">\r\n                                    <DollarSign className=\"text-green-600 mr-2\" size={24} />\r\n                                    <span className=\"text-lg font-semibold text-gray-900\">Total Amount:</span>\r\n                                </div>\r\n                                <div className={`text-2xl font-bold ${isCalculating ? 'text-orange-600' : 'text-green-600'}`}>\r\n                                    {getDisplayTotal()}\r\n                                </div>\r\n                            </div>\r\n                            {/** Amount in words */}\r\n                            <div className=\"mt-2\">\r\n                                <p className=\"text-sm text-gray-700 italic\">In words: {amountToWords(formData.totalAmount ? parseFloat(formData.totalAmount) : (formData.rate && formData.hoursSpent ? parseFloat(formData.rate) * parseFloat(formData.hoursSpent) : 0), formData.currency)}</p>\r\n                            </div>\r\n                            {formData.rate && formData.hoursSpent && (\r\n                                <p className=\"text-sm text-gray-600 mt-2\">\r\n                                    {currencySymbols[formData.currency]}{formData.rate} × {formData.hoursSpent} hours = {getDisplayTotal()}\r\n                                </p>\r\n                            )}\r\n                        </div>\r\n\r\n                        {/* Project */}\r\n                       \r\n                        {/* Remarks */}\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-2 flex items-center\">\r\n                                <MessageSquare className=\"mr-2 text-green-600\" size={16} />\r\n                                Remarks\r\n                            </label>\r\n                            <textarea\r\n                                placeholder=\"Additional notes or comments...\"\r\n                                rows={3}\r\n                                value={formData.remarks}\r\n                                onChange={handleChange('remarks')}\r\n                                className=\"w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none break-words overflow-wrap-anywhere whitespace-pre-wrap\"\r\n                                maxLength={500}\r\n                            />\r\n                            <div className=\"text-right text-sm text-gray-500 mt-1\">\r\n                                {formData.remarks.length}/500 characters\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Single Attachments Field - Multiple File Selection (Max 4) */}\r\n                        <div>\r\n                            <label className=\"block text-sm font-medium text-gray-700 mb-3 flex items-center\">\r\n                                <Paperclip className=\"mr-2 text-green-600\" size={16} />\r\n                                Attachments (Optional - Max 4 files)\r\n                            </label>\r\n\r\n                            {/* File Input */}\r\n                            <div className=\"mb-4\">\r\n                                <input\r\n                                    ref={fileInputRef}\r\n                                    type=\"file\"\r\n                                    onChange={handleFileChange}\r\n                                    className=\"hidden\"\r\n                                    accept=\".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt\"\r\n                                    multiple\r\n                                />\r\n                                <button\r\n                                    type=\"button\"\r\n                                    onClick={() => fileInputRef.current?.click()}\r\n                                    className=\"w-full px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-green-500 hover:bg-green-50 transition-colors flex items-center justify-center space-x-2 text-gray-600 hover:text-green-600\"\r\n                                    disabled={attachments.length >= 4}\r\n                                >\r\n                                    <Paperclip size={20} />\r\n                                    <span className=\"text-sm font-medium\">\r\n                                        {attachments.length === 0\r\n                                            ? 'Choose Files (Max 4)'\r\n                                            : attachments.length >= 4\r\n                                                ? 'Maximum 4 files reached'\r\n                                                : `Add More Files (${4 - attachments.length} remaining)`\r\n                                        }\r\n                                    </span>\r\n                                </button>\r\n                                <p className=\"text-xs text-gray-500 mt-2\">\r\n                                    Supported formats: PDF, DOC, DOCX, JPG, PNG, GIF, TXT (Max 10MB each)\r\n                                </p>\r\n                            </div>\r\n\r\n                            {/* Selected Files Display */}\r\n                            {attachments.length > 0 && (\r\n                                <div className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\">\r\n                                    <div className=\"flex items-center justify-between mb-3\">\r\n                                        <h4 className=\"text-sm font-medium text-gray-700 flex items-center\">\r\n                                            <FileText className=\"mr-1\" size={16} />\r\n                                            Selected Files ({attachments.length}/4)\r\n                                        </h4>\r\n                                        <button\r\n                                            type=\"button\"\r\n                                            onClick={removeAllAttachments}\r\n                                            className=\"text-red-500 hover:text-red-700 text-xs font-medium\"\r\n                                        >\r\n                                            Remove All\r\n                                        </button>\r\n                                    </div>\r\n\r\n                                    <div className=\"space-y-2\">\r\n                                        {attachments.map((file, index) => (\r\n                                            <div key={index} className=\"flex items-center justify-between bg-white rounded-md p-3 border border-gray-200\">\r\n                                                <div className=\"flex items-center space-x-3\">\r\n                                                    <div className=\"flex-shrink-0\">\r\n                                                        <FileText size={16} className=\"text-green-600\" />\r\n                                                    </div>\r\n                                                    <div className=\"flex-1 min-w-0\">\r\n                                                        <p className=\"text-sm text-gray-900 truncate\" title={file.name}>\r\n                                                            {file.name}\r\n                                                        </p>\r\n                                                        <p className=\"text-xs text-gray-500\">\r\n                                                            {formatFileSize(file.size)}\r\n                                                        </p>\r\n                                                    </div>\r\n                                                </div>\r\n                                                <button\r\n                                                    type=\"button\"\r\n                                                    onClick={() => removeAttachment(index)}\r\n                                                    className=\"text-red-500 hover:text-red-700 p-1\"\r\n                                                    title=\"Remove file\"\r\n                                                >\r\n                                                    <Trash2 size={16} />\r\n                                                </button>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n\r\n                                    {/* Total File Size */}\r\n                                    <div className=\"mt-3 pt-3 border-t border-gray-200\">\r\n                                        <p className=\"text-xs text-gray-600\">\r\n                                            Total size: {formatFileSize(getTotalFileSize())}\r\n                                        </p>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* File Count Indicator */}\r\n                            {attachments.length > 0 && (\r\n                                <div className=\"mt-2 p-2 bg-blue-50 border border-blue-200 rounded-md\">\r\n                                    <p className=\"text-sm text-blue-700\">\r\n                                        ✓ {attachments.length} file{attachments.length > 1 ? 's' : ''} ready to upload\r\n                                        {attachments.length < 4 && (\r\n                                            <span className=\"text-blue-600\"> • You can add {4 - attachments.length} more file{4 - attachments.length > 1 ? 's' : ''}</span>\r\n                                        )}\r\n                                    </p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Loading Overlay */}\r\n                {loading && (\r\n                    <div className=\"absolute inset-0 bg-white bg-opacity-90 flex items-center justify-center z-10\">\r\n                        <div className=\"text-center\">\r\n                            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4\"></div>\r\n                            <p className=\"text-lg font-medium text-gray-900\">\r\n                                {isFromInvoiceManagement ? 'Saving Invoice...' : 'Generating Invoice...'}\r\n                            </p>\r\n                            <p className=\"text-sm text-gray-600\">\r\n                                {isFromInvoiceManagement \r\n                                    ? 'Please wait while we save your invoice'\r\n                                    : (attachTimesheet\r\n                                        ? `Including ${viewMode?.toLowerCase() || ''} timesheet data...`\r\n                                        : attachments.length > 0\r\n                                            ? `Processing ${attachments.length} attachment${attachments.length > 1 ? 's' : ''}...`\r\n                                            : 'Please wait while we create your invoice'\r\n                                    )\r\n                                }\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                )}\r\n\r\n                {/* Visual footer details (tenant info for PDF footer preview) */}\r\n                <div className=\"px-6 pt-4 pb-2 border-t border-gray-100 bg-gray-50\">\r\n                    <div className=\"flex items-center justify-between text-sm text-gray-700\">\r\n                        <div>\r\n                            <div className=\"font-semibold\">{sessionStorage.getItem('tenantName') || ''}</div>\r\n                            <div>{sessionStorage.getItem('tenantEmail') || ''} • {sessionStorage.getItem('tenantContact') || ''}</div>\r\n                            <div className=\"text-xs text-gray-500\">{sessionStorage.getItem('tenantMailingAddress') || ''}</div>\r\n                        </div>\r\n                        <div className=\"text-right text-xs text-gray-500\">Page 1 of 1</div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div className=\"flex justify-end gap-3 pt-4 px-6 pb-6 border-t border-gray-200 bg-gray-50\">\r\n                    <button\r\n                        onClick={onClose}\r\n                        disabled={loading}\r\n                        className=\"px-6 py-2 border border-green-700 text-green-700 rounded-md hover:bg-green-50 transition-colors disabled:opacity-50\"\r\n                    >\r\n                        Cancel\r\n                    </button>\r\n                    \r\n                    {/* Show Preview and Generate Invoice buttons only when NOT from invoice management */}\r\n                    {!isFromInvoiceManagement && (\r\n                        <button\r\n                            onClick={handleInvoicePreview}\r\n                            disabled={loading}\r\n                            className=\"px-6 py-2 bg-green-700 text-white rounded-md hover:bg-green-800 transition-colors font-semibold disabled:opacity-50\"\r\n                        >\r\n                            Preview\r\n                        </button>\r\n                    )}\r\n\r\n                    <button\r\n                        onClick={handleSubmit}\r\n                        disabled={loading}\r\n                        className=\"px-6 py-2 bg-green-700 text-white rounded-md hover:bg-green-800 transition-colors font-semibold disabled:opacity-50 flex items-center\"\r\n                    >\r\n                        {loading ? (\r\n                            <>\r\n                                <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                                {isFromInvoiceManagement ? 'Saving...' : (attachTimesheet ? 'Including Timesheet...' : attachments.length > 0 ? 'Uploading...' : 'Generating...')}\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                <FileText className=\"mr-2\" size={16} />\r\n                                {isFromInvoiceManagement ? 'Save Invoice' : 'Generate Invoice'}\r\n                                {!isFromInvoiceManagement && (attachments.length > 0 || attachTimesheet) && (\r\n                                    <span className=\"ml-1 bg-green-600 text-green-200 text-xs px-1.5 py-0.5 rounded-full\">\r\n                                        {attachTimesheet ? '+📊' : `+${attachments.length}`}\r\n                                    </span>\r\n                                )}\r\n                            </>\r\n                        )}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n            <GlobalSnackbar\r\n                open={snackbar.open}\r\n                message={snackbar.message}\r\n                severity={snackbar.severity}\r\n                onClose={() => setSnackbar((prev) => ({ ...prev, open: false }))}\r\n            />\r\n        </div>\r\n    );\r\n};\r\n\r\nexport default AddInvoiceModal;","usedDeprecatedRules":[]}]